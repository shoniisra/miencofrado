import { __assign } from "tslib";
import { Subject, timer, of } from 'rxjs';
import { map, switchMap, take, tap, startWith, shareReplay } from 'rxjs/operators';
var LoadingBarState = /** @class */ (function () {
    function LoadingBarState(config) {
        var _this = this;
        if (config === void 0) { config = {}; }
        this.config = config;
        this.state = {
            action: null,
            value: 0,
            initialValue: 0,
        };
        this.requests = null;
        this.disabled = false;
        this.stream$ = new Subject();
        this._value$ = null;
        this.timer$ = function (s) {
            var state$ = of(s);
            switch (s.action) {
                case 'start':
                case 'increment':
                case 'set': {
                    if (s.action === 'start' && _this.config.latencyThreshold === 0 && s.value === 0) {
                        s.value = s.initialValue;
                    }
                    if (_this.requests > 0) {
                        state$ = timer(_this.config.latencyThreshold, 250).pipe(map(function (t) { return (__assign(__assign({}, s), { value: t === 0 ? _this.state.value || s.initialValue : _this._increment() })); }));
                    }
                    break;
                }
                case 'complete':
                case 'stop': {
                    // Attempt to aggregate any start/complete calls within 500ms:
                    state$ =
                        s.value === 0
                            ? of(__assign({}, s))
                            : timer(0, 500).pipe(take(2), map(function (t) { return ({ value: t === 0 ? 100 : 0 }); }));
                    break;
                }
            }
            return state$.pipe(map(function (next) { return (__assign(__assign({}, next), { action: 'set' })); }), tap(function (next) { return _this.next(next, false); }));
        };
        this.config = __assign({ latencyThreshold: 0 }, config);
    }
    Object.defineProperty(LoadingBarState.prototype, "value$", {
        get: function () {
            var _this = this;
            if (this._value$) {
                return this._value$;
            }
            return (this._value$ = this.stream$.asObservable().pipe(startWith(this.state), switchMap(function (s) { return _this.timer$(s); }), shareReplay(), map(function (s) { return s.value; })));
        },
        enumerable: true,
        configurable: true
    });
    LoadingBarState.prototype.start = function (initialValue) {
        if (initialValue === void 0) { initialValue = 2; }
        if (this.disabled) {
            return;
        }
        this.next({ action: 'start', initialValue: initialValue });
    };
    LoadingBarState.prototype.stop = function () {
        this.next({ action: 'stop' });
    };
    LoadingBarState.prototype.complete = function () {
        this.next({ action: 'complete' });
    };
    LoadingBarState.prototype.disable = function () {
        this.disabled = true;
    };
    LoadingBarState.prototype.set = function (value) {
        this.next({ action: 'set', value: value });
    };
    LoadingBarState.prototype.increment = function (value) {
        if (value === void 0) { value = 0; }
        this.next({ action: 'increment', value: value });
    };
    LoadingBarState.prototype.next = function (state, emitEvent) {
        if (emitEvent === void 0) { emitEvent = true; }
        switch (state.action) {
            case 'start':
                this.requests = (this.requests || 0) + 1;
                break;
            case 'complete':
                this.requests = (this.requests || 1) - 1;
                if (this.requests > 0) {
                    return;
                }
                break;
            case 'stop':
                this.requests = 0;
                break;
            case 'increment':
                state.value = this._increment(state.value);
                break;
        }
        this.state = __assign(__assign(__assign({}, this.state), { action: null }), state);
        if (emitEvent) {
            this.stream$.next(this.state);
        }
    };
    LoadingBarState.prototype._increment = function (rnd) {
        if (rnd === void 0) { rnd = 0; }
        var stat = this.state.value;
        if (stat >= 99) {
            rnd = 0;
        }
        if (rnd === 0) {
            if (stat >= 0 && stat < 25) {
                // Start out between 3 - 6% increments
                rnd = Math.random() * (5 - 3 + 1) + 3;
            }
            else if (stat >= 25 && stat < 65) {
                // increment between 0 - 3%
                rnd = Math.random() * 3;
            }
            else if (stat >= 65 && stat < 90) {
                // increment between 0 - 2%
                rnd = Math.random() * 2;
            }
            else if (stat >= 90 && stat < 99) {
                // finally, increment it .5 %
                rnd = 0.5;
            }
            else {
                // after 99%, don't increment:
                rnd = 0;
            }
        }
        return rnd + stat;
    };
    return LoadingBarState;
}());
export { LoadingBarState };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy1iYXIuc3RhdGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LWxvYWRpbmctYmFyL2NvcmUvIiwic291cmNlcyI6WyJsb2FkaW5nLWJhci5zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBU25GO0lBV0UseUJBQW9CLE1BQTZCO1FBQWpELGlCQUtDO1FBTG1CLHVCQUFBLEVBQUEsV0FBNkI7UUFBN0IsV0FBTSxHQUFOLE1BQU0sQ0FBdUI7UUFWekMsVUFBSyxHQUFxQjtZQUNoQyxNQUFNLEVBQUUsSUFBSTtZQUNaLEtBQUssRUFBRSxDQUFDO1lBQ1IsWUFBWSxFQUFFLENBQUM7U0FDaEIsQ0FBQztRQUNNLGFBQVEsR0FBRyxJQUFJLENBQUM7UUFDaEIsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNqQixZQUFPLEdBQUcsSUFBSSxPQUFPLEVBQW9CLENBQUM7UUFDMUMsWUFBTyxHQUFHLElBQUksQ0FBQztRQTJFZixXQUFNLEdBQUcsVUFBQyxDQUFtQjtZQUNuQyxJQUFJLE1BQU0sR0FBMEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFELFFBQVEsQ0FBQyxDQUFDLE1BQU0sRUFBRTtnQkFDaEIsS0FBSyxPQUFPLENBQUM7Z0JBQ2IsS0FBSyxXQUFXLENBQUM7Z0JBQ2pCLEtBQUssS0FBSyxDQUFDLENBQUM7b0JBQ1YsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLE9BQU8sSUFBSSxLQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsRUFBRTt3QkFDL0UsQ0FBQyxDQUFDLEtBQUssR0FB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LENBQUM7YUFDVDtTQUNGO1FBRUQsT0FBTyxHQUFHLEdBQUcsSUFBSSxDQUFDO0lBQ3BCLENBQUM7SUFDSCxzQkFBQztBQUFELENBQUMsQUFwSkQsSUFvSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0LCB0aW1lciwgb2YsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwLCB0YWtlLCB0YXAsIHN0YXJ0V2l0aCwgc2hhcmVSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBMb2FkaW5nQmFyQ29uZmlnIH0gZnJvbSAnLi9sb2FkaW5nLWJhci5jb25maWcnO1xuXG5pbnRlcmZhY2UgSUxvYWRpbmdCYXJTdGF0ZSB7XG4gIGFjdGlvbjogJ3N0YXJ0JyB8ICdjb21wbGV0ZScgfCAnc2V0JyB8ICdzdG9wJyB8ICdpbmNyZW1lbnQnO1xuICB2YWx1ZTogbnVtYmVyO1xuICBpbml0aWFsVmFsdWU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIExvYWRpbmdCYXJTdGF0ZSB7XG4gIHByaXZhdGUgc3RhdGU6IElMb2FkaW5nQmFyU3RhdGUgPSB7XG4gICAgYWN0aW9uOiBudWxsLFxuICAgIHZhbHVlOiAwLFxuICAgIGluaXRpYWxWYWx1ZTogMCxcbiAgfTtcbiAgcHJpdmF0ZSByZXF1ZXN0cyA9IG51bGw7XG4gIHByaXZhdGUgZGlzYWJsZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBzdHJlYW0kID0gbmV3IFN1YmplY3Q8SUxvYWRpbmdCYXJTdGF0ZT4oKTtcbiAgcHJpdmF0ZSBfdmFsdWUkID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbmZpZzogTG9hZGluZ0JhckNvbmZpZyA9IHt9KSB7XG4gICAgdGhpcy5jb25maWcgPSB7XG4gICAgICBsYXRlbmN5VGhyZXNob2xkOiAwLFxuICAgICAgLi4uY29uZmlnLFxuICAgIH07XG4gIH1cblxuICBnZXQgdmFsdWUkKCkge1xuICAgIGlmICh0aGlzLl92YWx1ZSQpIHtcbiAgICAgIHJldHVybiB0aGlzLl92YWx1ZSQ7XG4gICAgfVxuXG4gICAgcmV0dXJuICh0aGlzLl92YWx1ZSQgPSB0aGlzLnN0cmVhbSQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIHN0YXJ0V2l0aCh0aGlzLnN0YXRlKSxcbiAgICAgIHN3aXRjaE1hcCgocykgPT4gdGhpcy50aW1lciQocykpLFxuICAgICAgc2hhcmVSZXBsYXkoKSxcbiAgICAgIG1hcCgocykgPT4gcy52YWx1ZSksXG4gICAgKSk7XG4gIH1cblxuICBzdGFydChpbml0aWFsVmFsdWUgPSAyKSB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdzdGFydCcsIGluaXRpYWxWYWx1ZSB9KTtcbiAgfVxuXG4gIHN0b3AoKSB7XG4gICAgdGhpcy5uZXh0KHsgYWN0aW9uOiAnc3RvcCcgfSk7XG4gIH1cblxuICBjb21wbGV0ZSgpIHtcbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdjb21wbGV0ZScgfSk7XG4gIH1cblxuICBkaXNhYmxlKCkge1xuICAgIHRoaXMuZGlzYWJsZWQgPSB0cnVlO1xuICB9XG5cbiAgc2V0KHZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdzZXQnLCB2YWx1ZSB9KTtcbiAgfVxuXG4gIGluY3JlbWVudCh2YWx1ZSA9IDApIHtcbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdpbmNyZW1lbnQnLCB2YWx1ZSB9KTtcbiAgfVxuXG4gIHByaXZhdGUgbmV4dChzdGF0ZTogUGFydGlhbDxJTG9hZGluZ0JhclN0YXRlPiwgZW1pdEV2ZW50ID0gdHJ1ZSkge1xuICAgIHN3aXRjaCAoc3RhdGUuYWN0aW9uKSB7XG4gICAgICBjYXNlICdzdGFydCc6XG4gICAgICAgIHRoaXMucmVxdWVzdHMgPSAodGhpcy5yZXF1ZXN0cyB8fCAwKSArIDE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY29tcGxldGUnOlxuICAgICAgICB0aGlzLnJlcXVlc3RzID0gKHRoaXMucmVxdWVzdHMgfHwgMSkgLSAxO1xuICAgICAgICBpZiAodGhpcy5yZXF1ZXN0cyA+IDApIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdzdG9wJzpcbiAgICAgICAgdGhpcy5yZXF1ZXN0cyA9IDA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnaW5jcmVtZW50JzpcbiAgICAgICAgc3RhdGUudmFsdWUgPSB0aGlzLl9pbmNyZW1lbnQoc3RhdGUudmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICB0aGlzLnN0YXRlID0geyAuLi50aGlzLnN0YXRlLCBhY3Rpb246IG51bGwsIC4uLnN0YXRlIH07XG4gICAgaWYgKGVtaXRFdmVudCkge1xuICAgICAgdGhpcy5zdHJlYW0kLm5leHQodGhpcy5zdGF0ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0aW1lciQgPSAoczogSUxvYWRpbmdCYXJTdGF0ZSkgPT4ge1xuICAgIGxldCBzdGF0ZSQ6IE9ic2VydmFibGU8UGFydGlhbDxJTG9hZGluZ0JhclN0YXRlPj4gPSBvZihzKTtcbiAgICBzd2l0Y2ggKHMuYWN0aW9uKSB7XG4gICAgICBjYXNlICdzdGFydCc6XG4gICAgICBjYXNlICdpbmNyZW1lbnQnOlxuICAgICAgY2FzZSAnc2V0Jzoge1xuICAgICAgICBpZiAocy5hY3Rpb24gPT09ICdzdGFydCcgJiYgdGhpcy5jb25maWcubGF0ZW5jeVRocmVzaG9sZCA9PT0gMCAmJiBzLnZhbHVlID09PSAwKSB7XG4gICAgICAgICAgcy52YWx1ZSA9IHMuaW5pdGlhbFZhbHVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMucmVxdWVzdHMgPiAwKSB7XG4gICAgICAgICAgc3RhdGUkID0gdGltZXIodGhpcy5jb25maWcubGF0ZW5jeVRocmVzaG9sZCwgMjUwKS5waXBlKFxuICAgICAgICAgICAgbWFwKCh0KSA9PiAoeyAuLi5zLCB2YWx1ZTogdCA9PT0gMCA/IHRoaXMuc3RhdGUudmFsdWUgfHwgcy5pbml0aWFsVmFsdWUgOiB0aGlzLl9pbmNyZW1lbnQoKSB9KSksXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ2NvbXBsZXRlJzpcbiAgICAgIGNhc2UgJ3N0b3AnOiB7XG4gICAgICAgIC8vIEF0dGVtcHQgdG8gYWdncmVnYXRlIGFueSBzdGFydC9jb21wbGV0ZSBjYWxscyB3aXRoaW4gNTAwbXM6XG4gICAgICAgIHN0YXRlJCA9XG4gICAgICAgICAgcy52YWx1ZSA9PT0gMFxuICAgICAgICAgICAgPyBvZih7IC4uLnMgfSlcbiAgICAgICAgICAgIDogdGltZXIoMCwgNTAwKS5waXBlKFxuICAgICAgICAgICAgICAgIHRha2UoMiksXG4gICAgICAgICAgICAgICAgbWFwKCh0KSA9PiAoeyB2YWx1ZTogdCA9PT0gMCA/IDEwMCA6IDAgfSkpLFxuICAgICAgICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gc3RhdGUkLnBpcGUoXG4gICAgICBtYXAoKG5leHQpID0+IDxJTG9hZGluZ0JhclN0YXRlPnsgLi4ubmV4dCwgYWN0aW9uOiAnc2V0JyB9KSxcbiAgICAgIHRhcCgobmV4dCkgPT4gdGhpcy5uZXh0KG5leHQsIGZhbHNlKSksXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIF9pbmNyZW1lbnQocm5kID0gMCkge1xuICAgIGNvbnN0IHN0YXQgPSB0aGlzLnN0YXRlLnZhbHVlO1xuICAgIGlmIChzdGF0ID49IDk5KSB7XG4gICAgICBybmQgPSAwO1xuICAgIH1cblxuICAgIGlmIChybmQgPT09IDApIHtcbiAgICAgIGlmIChzdGF0ID49IDAgJiYgc3RhdCA8IDI1KSB7XG4gICAgICAgIC8vIFN0YXJ0IG91dCBiZXR3ZWVuIDMgLSA2JSBpbmNyZW1lbnRzXG4gICAgICAgIHJuZCA9IE1hdGgucmFuZG9tKCkgKiAoNSAtIDMgKyAxKSArIDM7XG4gICAgICB9IGVsc2UgaWYgKHN0YXQgPj0gMjUgJiYgc3RhdCA8IDY1KSB7XG4gICAgICAgIC8vIGluY3JlbWVudCBiZXR3ZWVuIDAgLSAzJVxuICAgICAgICBybmQgPSBNYXRoLnJhbmRvbSgpICogMztcbiAgICAgIH0gZWxzZSBpZiAoc3RhdCA+PSA2NSAmJiBzdGF0IDwgOTApIHtcbiAgICAgICAgLy8gaW5jcmVtZW50IGJldHdlZW4gMCAtIDIlXG4gICAgICAgIHJuZCA9IE1hdGgucmFuZG9tKCkgKiAyO1xuICAgICAgfSBlbHNlIGlmIChzdGF0ID49IDkwICYmIHN0YXQgPCA5OSkge1xuICAgICAgICAvLyBmaW5hbGx5LCBpbmNyZW1lbnQgaXQgLjUgJVxuICAgICAgICBybmQgPSAwLjU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBhZnRlciA5OSUsIGRvbid0IGluY3JlbWVudDpcbiAgICAgICAgcm5kID0gMDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcm5kICsgc3RhdDtcbiAgfVxufVxuIl19