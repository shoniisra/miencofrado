import { Subject, timer, of } from 'rxjs';
import { map, switchMap, take, tap, startWith, shareReplay } from 'rxjs/operators';
export class LoadingBarState {
    constructor(config = {}) {
        this.config = config;
        this.state = {
            action: null,
            value: 0,
            initialValue: 0,
        };
        this.requests = null;
        this.disabled = false;
        this.stream$ = new Subject();
        this._value$ = null;
        this.timer$ = (s) => {
            let state$ = of(s);
            switch (s.action) {
                case 'start':
                case 'increment':
                case 'set': {
                    if (s.action === 'start' && this.config.latencyThreshold === 0 && s.value === 0) {
                        s.value = s.initialValue;
                    }
                    if (this.requests > 0) {
                        state$ = timer(this.config.latencyThreshold, 250).pipe(map((t) => (Object.assign(Object.assign({}, s), { value: t === 0 ? this.state.value || s.initialValue : this._increment() }))));
                    }
                    break;
                }
                case 'complete':
                case 'stop': {
                    // Attempt to aggregate any start/complete calls within 500ms:
                    state$ =
                        s.value === 0
                            ? of(Object.assign({}, s))
                            : timer(0, 500).pipe(take(2), map((t) => ({ value: t === 0 ? 100 : 0 })));
                    break;
                }
            }
            return state$.pipe(map((next) => (Object.assign(Object.assign({}, next), { action: 'set' }))), tap((next) => this.next(next, false)));
        };
        this.config = Object.assign({ latencyThreshold: 0 }, config);
    }
    get value$() {
        if (this._value$) {
            return this._value$;
        }
        return (this._value$ = this.stream$.asObservable().pipe(startWith(this.state), switchMap((s) => this.timer$(s)), shareReplay(), map((s) => s.value)));
    }
    start(initialValue = 2) {
        if (this.disabled) {
            return;
        }
        this.next({ action: 'start', initialValue });
    }
    stop() {
        this.next({ action: 'stop' });
    }
    complete() {
        this.next({ action: 'complete' });
    }
    disable() {
        this.disabled = true;
    }
    set(value) {
        this.next({ action: 'set', value });
    }
    increment(value = 0) {
        this.next({ action: 'increment', value });
    }
    next(state, emitEvent = true) {
        switch (state.action) {
            case 'start':
                this.requests = (this.requests || 0) + 1;
                break;
            case 'complete':
                this.requests = (this.requests || 1) - 1;
                if (this.requests > 0) {
                    return;
                }
                break;
            case 'stop':
                this.requests = 0;
                break;
            case 'increment':
                state.value = this._increment(state.value);
                break;
        }
        this.state = Object.assign(Object.assign(Object.assign({}, this.state), { action: null }), state);
        if (emitEvent) {
            this.stream$.next(this.state);
        }
    }
    _increment(rnd = 0) {
        const stat = this.state.value;
        if (stat >= 99) {
            rnd = 0;
        }
        if (rnd === 0) {
            if (stat >= 0 && stat < 25) {
                // Start out between 3 - 6% increments
                rnd = Math.random() * (5 - 3 + 1) + 3;
            }
            else if (stat >= 25 && stat < 65) {
                // increment between 0 - 3%
                rnd = Math.random() * 3;
            }
            else if (stat >= 65 && stat < 90) {
                // increment between 0 - 2%
                rnd = Math.random() * 2;
            }
            else if (stat >= 90 && stat < 99) {
                // finally, increment it .5 %
                rnd = 0.5;
            }
            else {
                // after 99%, don't increment:
                rnd = 0;
            }
        }
        return rnd + stat;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy1iYXIuc3RhdGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LWxvYWRpbmctYmFyL2NvcmUvIiwic291cmNlcyI6WyJsb2FkaW5nLWJhci5zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFTbkYsTUFBTSxPQUFPLGVBQWU7SUFXMUIsWUFBb0IsU0FBMkIsRUFBRTtRQUE3QixXQUFNLEdBQU4sTUFBTSxDQUF1QjtRQVZ6QyxVQUFLLEdBQXFCO1lBQ2hDLE1BQU0sRUFBRSxJQUFJO1lBQ1osS0FBSyxFQUFFLENBQUM7WUFDUixZQUFZLEVBQUUsQ0FBQztTQUNoQixDQUFDO1FBQ00sYUFBUSxHQUFHLElBQUksQ0FBQztRQUNoQixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLFlBQU8sR0FBRyxJQUFJLE9BQU8sRUFBb0IsQ0FBQztRQUMxQyxZQUFPLEdBQUcsSUFBSSxDQUFDO1FBMkVmLFdBQU0sR0FBRyxDQUFDLENBQW1CLEVBQUUsRUFBRTtZQUN2QyxJQUFJLE1BQU0sR0FBMEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFELFFBQVEsQ0FBQyxDQUFDLE1BQU0sRUFBRTtnQkFDaEIsS0FBSyxPQUFPLENBQUM7Z0JBQ2IsS0FBSyxXQUFXLENBQUM7Z0JBQ2pCLEtBQUssS0FBSyxDQUFDLENBQUM7b0JBQ1YsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLE9BQU8sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsRUFBRTt3QkFDL0UsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDO3FCQUMxQjtvQkFFRCxJQUFJLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxFQUFFO3dCQUNyQixNQUFNLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUNwRCxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGlDQUFNLENBQUMsS0FBRSxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFHLENBQUMsQ0FDaEcsQ0FBQztxQkFDSDtvQkFDRCxNQUFNO2lCQUNQO2dCQUNELEtBQUssVUFBVSxDQUFDO2dCQUNoQixLQUFLLE1BQU0sQ0FBQyxDQUFDO29CQUNYLDhEQUE4RDtvQkFDOUQsTUFBTTt3QkFDSixDQUFDLENBQUMsS0FBSyxLQUFLLENBQUM7NEJBQ1gsQ0FBQyxDQUFDLEVBQUUsbUJBQU0sQ0FBQyxFQUFHOzRCQUNkLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUNQLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FDM0MsQ0FBQztvQkFDUixNQUFNO2lCQUNQO2FBQ0Y7WUFFRCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQ2hCLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQSxnQ0FBdUIsSUFBSSxLQUFFLE1BQU0sRUFBRSxLQUFLLEdBQUUsQ0FBQSxDQUFDLEVBQzNELEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FDdEMsQ0FBQztRQUNKLENBQUMsQ0FBQztRQTNHQSxJQUFJLENBQUMsTUFBTSxtQkFDVCxnQkFBZ0IsRUFBRSxDQUFDLElBQ2hCLE1BQU0sQ0FDVixDQUFDO0lBQ0osQ0FBQztJQUVELElBQUksTUFBTTtRQUNSLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDckI7UUFFRCxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDckQsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFDckIsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQ2hDLFdBQVcsRUFBRSxFQUNiLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUNwQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksR0FBRyxDQUFDO1FBQ3BCLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNqQixPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxJQUFJO1FBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxPQUFPO1FBQ0wsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDdkIsQ0FBQztJQUVELEdBQUcsQ0FBQyxLQUFhO1FBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQsU0FBUyxDQUFDLEtBQUssR0FBRyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVPLElBQUksQ0FBQyxLQUFnQyxFQUFFLFNBQVMsR0FBRyxJQUFJO1FBQzdELFFBQVEsS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUNwQixLQUFLLE9BQU87Z0JBQ1YsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUN6QyxNQUFNO1lBQ1IsS0FBSyxVQUFVO2dCQUNiLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDekMsSUFBSSxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsRUFBRTtvQkFDckIsT0FBTztpQkFDUjtnQkFDRCxNQUFNO1lBQ1IsS0FBSyxNQUFNO2dCQUNULElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO2dCQUNsQixNQUFNO1lBQ1IsS0FBSyxXQUFXO2dCQUNkLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzNDLE1BQU07U0FDVDtRQUVELElBQUksQ0FBQyxLQUFLLGlEQUFRLElBQUksQ0FBQyxLQUFLLEtBQUUsTUFBTSxFQUFFLElBQUksS0FBSyxLQUFLLENBQUUsQ0FBQztRQUN2RCxJQUFJLFNBQVMsRUFBRTtZQUNiLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMvQjtJQUNILENBQUM7SUF1Q08sVUFBVSxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ3hCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDO1FBQzlCLElBQUksSUFBSSxJQUFJLEVBQUUsRUFBRTtZQUNkLEdBQUcsR0FBRyxDQUFDLENBQUM7U0FDVDtRQUVELElBQUksR0FBRyxLQUFLLENBQUMsRUFBRTtZQUNiLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLEdBQUcsRUFBRSxFQUFFO2dCQUMxQixzQ0FBc0M7Z0JBQ3RDLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN2QztpQkFBTSxJQUFJLElBQUksSUFBSSxFQUFFLElBQUksSUFBSSxHQUFHLEVBQUUsRUFBRTtnQkFDbEMsMkJBQTJCO2dCQUMzQixHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQzthQUN6QjtpQkFBTSxJQUFJLElBQUksSUFBSSxFQUFFLElBQUksSUFBSSxHQUFHLEVBQUUsRUFBRTtnQkFDbEMsMkJBQTJCO2dCQUMzQixHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQzthQUN6QjtpQkFBTSxJQUFJLElBQUksSUFBSSxFQUFFLElBQUksSUFBSSxHQUFHLEVBQUUsRUFBRTtnQkFDbEMsNkJBQTZCO2dCQUM3QixHQUFHLEdBQUcsR0FBRyxDQUFDO2FBQ1g7aUJBQU07Z0JBQ0wsOEJBQThCO2dCQUM5QixHQUFHLEdBQUcsQ0FBQyxDQUFDO2FBQ1Q7U0FDRjtRQUVELE9BQU8sR0FBRyxHQUFHLElBQUksQ0FBQztJQUNwQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0LCB0aW1lciwgb2YsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwLCB0YWtlLCB0YXAsIHN0YXJ0V2l0aCwgc2hhcmVSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBMb2FkaW5nQmFyQ29uZmlnIH0gZnJvbSAnLi9sb2FkaW5nLWJhci5jb25maWcnO1xuXG5pbnRlcmZhY2UgSUxvYWRpbmdCYXJTdGF0ZSB7XG4gIGFjdGlvbjogJ3N0YXJ0JyB8ICdjb21wbGV0ZScgfCAnc2V0JyB8ICdzdG9wJyB8ICdpbmNyZW1lbnQnO1xuICB2YWx1ZTogbnVtYmVyO1xuICBpbml0aWFsVmFsdWU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIExvYWRpbmdCYXJTdGF0ZSB7XG4gIHByaXZhdGUgc3RhdGU6IElMb2FkaW5nQmFyU3RhdGUgPSB7XG4gICAgYWN0aW9uOiBudWxsLFxuICAgIHZhbHVlOiAwLFxuICAgIGluaXRpYWxWYWx1ZTogMCxcbiAgfTtcbiAgcHJpdmF0ZSByZXF1ZXN0cyA9IG51bGw7XG4gIHByaXZhdGUgZGlzYWJsZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBzdHJlYW0kID0gbmV3IFN1YmplY3Q8SUxvYWRpbmdCYXJTdGF0ZT4oKTtcbiAgcHJpdmF0ZSBfdmFsdWUkID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbmZpZzogTG9hZGluZ0JhckNvbmZpZyA9IHt9KSB7XG4gICAgdGhpcy5jb25maWcgPSB7XG4gICAgICBsYXRlbmN5VGhyZXNob2xkOiAwLFxuICAgICAgLi4uY29uZmlnLFxuICAgIH07XG4gIH1cblxuICBnZXQgdmFsdWUkKCkge1xuICAgIGlmICh0aGlzLl92YWx1ZSQpIHtcbiAgICAgIHJldHVybiB0aGlzLl92YWx1ZSQ7XG4gICAgfVxuXG4gICAgcmV0dXJuICh0aGlzLl92YWx1ZSQgPSB0aGlzLnN0cmVhbSQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIHN0YXJ0V2l0aCh0aGlzLnN0YXRlKSxcbiAgICAgIHN3aXRjaE1hcCgocykgPT4gdGhpcy50aW1lciQocykpLFxuICAgICAgc2hhcmVSZXBsYXkoKSxcbiAgICAgIG1hcCgocykgPT4gcy52YWx1ZSksXG4gICAgKSk7XG4gIH1cblxuICBzdGFydChpbml0aWFsVmFsdWUgPSAyKSB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdzdGFydCcsIGluaXRpYWxWYWx1ZSB9KTtcbiAgfVxuXG4gIHN0b3AoKSB7XG4gICAgdGhpcy5uZXh0KHsgYWN0aW9uOiAnc3RvcCcgfSk7XG4gIH1cblxuICBjb21wbGV0ZSgpIHtcbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdjb21wbGV0ZScgfSk7XG4gIH1cblxuICBkaXNhYmxlKCkge1xuICAgIHRoaXMuZGlzYWJsZWQgPSB0cnVlO1xuICB9XG5cbiAgc2V0KHZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdzZXQnLCB2YWx1ZSB9KTtcbiAgfVxuXG4gIGluY3JlbWVudCh2YWx1ZSA9IDApIHtcbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdpbmNyZW1lbnQnLCB2YWx1ZSB9KTtcbiAgfVxuXG4gIHByaXZhdGUgbmV4dChzdGF0ZTogUGFydGlhbDxJTG9hZGluZ0JhclN0YXRlPiwgZW1pdEV2ZW50ID0gdHJ1ZSkge1xuICAgIHN3aXRjaCAoc3RhdGUuYWN0aW9uKSB7XG4gICAgICBjYXNlICdzdGFydCc6XG4gICAgICAgIHRoaXMucmVxdWVzdHMgPSAodGhpcy5yZXF1ZXN0cyB8fCAwKSArIDE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY29tcGxldGUnOlxuICAgICAgICB0aGlzLnJlcXVlc3RzID0gKHRoaXMucmVxdWVzdHMgfHwgMSkgLSAxO1xuICAgICAgICBpZiAodGhpcy5yZXF1ZXN0cyA+IDApIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdzdG9wJzpcbiAgICAgICAgdGhpcy5yZXF1ZXN0cyA9IDA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnaW5jcmVtZW50JzpcbiAgICAgICAgc3RhdGUudmFsdWUgPSB0aGlzLl9pbmNyZW1lbnQoc3RhdGUudmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICB0aGlzLnN0YXRlID0geyAuLi50aGlzLnN0YXRlLCBhY3Rpb246IG51bGwsIC4uLnN0YXRlIH07XG4gICAgaWYgKGVtaXRFdmVudCkge1xuICAgICAgdGhpcy5zdHJlYW0kLm5leHQodGhpcy5zdGF0ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0aW1lciQgPSAoczogSUxvYWRpbmdCYXJTdGF0ZSkgPT4ge1xuICAgIGxldCBzdGF0ZSQ6IE9ic2VydmFibGU8UGFydGlhbDxJTG9hZGluZ0JhclN0YXRlPj4gPSBvZihzKTtcbiAgICBzd2l0Y2ggKHMuYWN0aW9uKSB7XG4gICAgICBjYXNlICdzdGFydCc6XG4gICAgICBjYXNlICdpbmNyZW1lbnQnOlxuICAgICAgY2FzZSAnc2V0Jzoge1xuICAgICAgICBpZiAocy5hY3Rpb24gPT09ICdzdGFydCcgJiYgdGhpcy5jb25maWcubGF0ZW5jeVRocmVzaG9sZCA9PT0gMCAmJiBzLnZhbHVlID09PSAwKSB7XG4gICAgICAgICAgcy52YWx1ZSA9IHMuaW5pdGlhbFZhbHVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMucmVxdWVzdHMgPiAwKSB7XG4gICAgICAgICAgc3RhdGUkID0gdGltZXIodGhpcy5jb25maWcubGF0ZW5jeVRocmVzaG9sZCwgMjUwKS5waXBlKFxuICAgICAgICAgICAgbWFwKCh0KSA9PiAoeyAuLi5zLCB2YWx1ZTogdCA9PT0gMCA/IHRoaXMuc3RhdGUudmFsdWUgfHwgcy5pbml0aWFsVmFsdWUgOiB0aGlzLl9pbmNyZW1lbnQoKSB9KSksXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ2NvbXBsZXRlJzpcbiAgICAgIGNhc2UgJ3N0b3AnOiB7XG4gICAgICAgIC8vIEF0dGVtcHQgdG8gYWdncmVnYXRlIGFueSBzdGFydC9jb21wbGV0ZSBjYWxscyB3aXRoaW4gNTAwbXM6XG4gICAgICAgIHN0YXRlJCA9XG4gICAgICAgICAgcy52YWx1ZSA9PT0gMFxuICAgICAgICAgICAgPyBvZih7IC4uLnMgfSlcbiAgICAgICAgICAgIDogdGltZXIoMCwgNTAwKS5waXBlKFxuICAgICAgICAgICAgICAgIHRha2UoMiksXG4gICAgICAgICAgICAgICAgbWFwKCh0KSA9PiAoeyB2YWx1ZTogdCA9PT0gMCA/IDEwMCA6IDAgfSkpLFxuICAgICAgICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gc3RhdGUkLnBpcGUoXG4gICAgICBtYXAoKG5leHQpID0+IDxJTG9hZGluZ0JhclN0YXRlPnsgLi4ubmV4dCwgYWN0aW9uOiAnc2V0JyB9KSxcbiAgICAgIHRhcCgobmV4dCkgPT4gdGhpcy5uZXh0KG5leHQsIGZhbHNlKSksXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIF9pbmNyZW1lbnQocm5kID0gMCkge1xuICAgIGNvbnN0IHN0YXQgPSB0aGlzLnN0YXRlLnZhbHVlO1xuICAgIGlmIChzdGF0ID49IDk5KSB7XG4gICAgICBybmQgPSAwO1xuICAgIH1cblxuICAgIGlmIChybmQgPT09IDApIHtcbiAgICAgIGlmIChzdGF0ID49IDAgJiYgc3RhdCA8IDI1KSB7XG4gICAgICAgIC8vIFN0YXJ0IG91dCBiZXR3ZWVuIDMgLSA2JSBpbmNyZW1lbnRzXG4gICAgICAgIHJuZCA9IE1hdGgucmFuZG9tKCkgKiAoNSAtIDMgKyAxKSArIDM7XG4gICAgICB9IGVsc2UgaWYgKHN0YXQgPj0gMjUgJiYgc3RhdCA8IDY1KSB7XG4gICAgICAgIC8vIGluY3JlbWVudCBiZXR3ZWVuIDAgLSAzJVxuICAgICAgICBybmQgPSBNYXRoLnJhbmRvbSgpICogMztcbiAgICAgIH0gZWxzZSBpZiAoc3RhdCA+PSA2NSAmJiBzdGF0IDwgOTApIHtcbiAgICAgICAgLy8gaW5jcmVtZW50IGJldHdlZW4gMCAtIDIlXG4gICAgICAgIHJuZCA9IE1hdGgucmFuZG9tKCkgKiAyO1xuICAgICAgfSBlbHNlIGlmIChzdGF0ID49IDkwICYmIHN0YXQgPCA5OSkge1xuICAgICAgICAvLyBmaW5hbGx5LCBpbmNyZW1lbnQgaXQgLjUgJVxuICAgICAgICBybmQgPSAwLjU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBhZnRlciA5OSUsIGRvbid0IGluY3JlbWVudDpcbiAgICAgICAgcm5kID0gMDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcm5kICsgc3RhdDtcbiAgfVxufVxuIl19